## 雪花算发(SnowFlake)

### 唯一ID

### 构成
    1、全长64位；
    2、第1位是代表正负，1负数，0正数；
    3、接着41位，时间戳，转换为时间，大概为69年；（2^41-1 / (1000 * 60 * 60 * 23 * 365) = 69）
    4、接着10位，机器码，最多可以部署1024台机器；
    5、接着12位，序列号，每毫秒内最多可以生成4096个ID；（防止同一毫秒内的ID生成重复）

### 雪花算法相关问题以及解决方案

1. 时间回拨问题

问题：在获取时间的时候，可能会出现时间回拨的问题，什么是时间回拨呢？

原因：时间回拨就是服务器上的时间突然倒退到之前的时间。

认为原因，把系统环境的时间改了
有时候不同的机器上需要同步时间，可能不同机器之间存在误差，那么可能会出现时间回拨问题

解决方案

回拨时间小的时候，不生成ID，循环等待到时间点到达。（只适合时钟回拨较小的）
利用拓展位，回拨之后再扩展位上加1就可以了，这样ID依然可以保持唯一。但是找个要求我们提前预留出位数，要么从机器id中，要么从序列号中，腾出一定的位，在时间回拨的时候，这个位置+1.
缓存workerID，减少第三方组件的依赖
由于强依赖时钟，对时间的要求比较敏感，在机器工作时NTP同步也会造成秒级别的回退，建议可以直接关闭NTP同步。要么在时钟回拨的时候直接不提供服务直接返回ERROR_CODE，等时钟追上即可。或者做一层重试，然后上报报警系统，更或者是发现有时钟回拨之后自动摘除本身节点并报警